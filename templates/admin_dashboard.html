<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - ReqAgent Admin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .navbar-brand {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
        }
        
        .navbar-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 1rem;
        }
        
        .navbar-nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .navbar-nav a:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .navbar-user {
            color: white;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .header {
            margin-bottom: 2rem;
        }
        
        .header h1 {
            color: #333;
            margin: 0 0 0.5rem 0;
        }
        
        .header p {
            color: #666;
            margin: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .stat-card.raw { border-left-color: #dc3545; }
        .stat-card.reviewed { border-left-color: #ffc107; }
        .stat-card.approved { border-left-color: #28a745; }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.25rem;
        }
        
        .admin-functions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .function-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .function-card:hover {
            transform: translateY(-2px);
        }
        
        .function-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .function-card h3 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }
        
        .function-card p {
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .recent-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .recent-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recent-item:last-child {
            border-bottom: none;
        }
        
        .recent-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .recent-meta {
            font-size: 0.8rem;
            color: #666;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-raw { background: #f8d7da; color: #721c24; }
        .status-reviewed { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        
        .todo-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .todo-section h2 {
            color: #856404;
            margin: 0 0 1rem 0;
        }
        
        .todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .todo-item {
            padding: 0.5rem 0;
            color: #856404;
        }
        
        .todo-item::before {
            content: "‚ö†Ô∏è ";
            margin-right: 0.5rem;
        }
        
        /* Step 1 QA Workflow Styles */
        .workflow-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #667eea;
        }
        
        .workflow-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .workflow-header h2 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .workflow-header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .parse-section {
            margin-bottom: 1.5rem;
        }
        
        .parse-section h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .url-input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .url-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .form-control {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .multi-select {
            min-height: 120px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding-top: 1rem;
            border-top: 2px solid #f0f0f0;
        }
        
        .message {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .message.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .success-message {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-top: 1rem;
        }
        
        .success-message h4 {
            color: #155724;
            margin-bottom: 0.5rem;
        }
        
        .success-message p {
            color: #155724;
            margin-bottom: 1rem;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Disabled/placeholder styles */
        .disabled-link {
            color: #888 !important;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .disabled-link:hover {
            color: #888 !important;
            text-decoration: none;
        }

        .btn-disabled {
            background: #f5f5f5;
            border: 1px solid #ddd;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-disabled:hover {
            background: #f5f5f5;
            border-color: #ddd;
            color: #666;
        }

        .placeholder-note {
            margin-top: 8px;
            font-style: italic;
        }

        .text-muted {
            color: #666;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        /* Loading states */
        #parse-btn:disabled, #save-record-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Step 2 Blog Generation Styles */
        .generation-controls {
            margin-bottom: 1.5rem;
        }
        
        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group.full-width {
            grid-column: 1 / -1;
        }
        
        .control-actions {
            display: flex;
            justify-content: center;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .blog-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .blog-textarea {
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .char-count {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            margin-top: 0.25rem;
        }
        
        .char-count.warning {
            color: #856404;
        }
        
        .char-count.error {
            color: #721c24;
        }
        
        .success-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        /* Disable buttons when loading */
        #generate-blog-btn:disabled, #publish-wp-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Step 3 Proposal Template Styles */
        .template-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .template-section-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .template-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .template-section-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .template-section-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .template-section-controls .btn {
            padding: 0.25rem 0.5rem;
            font-size: 12px;
            min-width: auto;
        }
        
        .template-section-heading {
            flex: 1;
            font-weight: bold;
            font-size: 16px;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-left: 0.5rem;
        }
        
        .template-section-instruction {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.4;
            resize: vertical;
            min-height: 80px;
        }
        
        .download-info {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 2rem;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .download-details p {
            margin: 0.5rem 0;
            font-size: 14px;
        }
        
        .download-actions {
            display: flex;
            gap: 1rem;
            flex-direction: column;
        }
        
        .workflow-completion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            margin-top: 2rem;
        }
        
        .workflow-completion h4 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        
        .completion-checklist {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
            text-align: left;
            display: inline-block;
        }
        
        .completion-checklist li {
            margin: 0.5rem 0;
            font-size: 14px;
        }
        
        .completion-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .completion-actions .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        .completion-actions .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Step 3 Loading States */
        #generate-template-btn:disabled, #finalize-template-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* URL Already Exists Warning Styles */
        .warning-card {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-left: 5px solid #ffc107;
        }
        
        .warning-card h3 {
            color: #856404;
            margin-top: 0;
        }
        
        .existing-info {
            margin: 1rem 0;
        }
        
        .existing-details {
            background: #ffffff;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            margin-top: 0.5rem;
        }
        
        .existing-details p {
            margin: 0.5rem 0;
            font-size: 14px;
        }
        
        .reparse-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        /* Comparison UI Styles */
        .comparison-help {
            color: #666;
            font-style: italic;
            margin-bottom: 1.5rem;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .comparison-column h4 {
            color: #495057;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #dee2e6;
        }
        
        .data-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-preview .field-item {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-preview .field-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .data-preview .field-label {
            font-weight: bold;
            color: #495057;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .data-preview .field-value {
            color: #333;
            word-wrap: break-word;
        }
        
        .data-preview .field-changed {
            background: #fff3cd;
            padding: 0.25rem;
            border-radius: 3px;
            border-left: 3px solid #ffc107;
        }
        
        .comparison-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Loading states for re-parse */
        #reparse-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Responsive design for comparison */
        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/admin/dashboard" class="navbar-brand">
                üöÄ ReqAgent Admin
            </a>
            
            <ul class="navbar-nav">
                <li><a href="/admin/qa-review">üìã QA Review</a></li>
                <li><a href="/admin/proposal-template/start">üìÑ Template Generator</a></li>
                <li><a href="/admin/dashboard">üìù Post Publisher</a></li>
                <li><a href="/admin/analytics">üìä Analytics & Ops</a></li>
                <li><a href="/admin/logs">üìã Admin Logs</a></li>
                <li><a href="/admin/migrations">üîÑ Migrations</a></li>
            </ul>
            
            <div class="navbar-user">
                <span>üë§ {{ current_user }}</span>
                <a href="/admin/logout" class="btn btn-secondary">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>{{ page_title }}</h1>
            <p>Welcome to the ReqAgent administrative interface. Manage funding opportunities, generate proposals, and analyze performance.</p>
        </div>

        <!-- Step 1: QA Workflow - Parse & Curate Funding Opportunities -->
        <div class="workflow-section">
            <div class="workflow-header">
                <h2>üîç Step 1: Parse & Curate Funding Opportunities</h2>
                <p>Enter a funding URL, parse the data, edit fields as needed, and save the final curated record.</p>
            </div>

            <!-- URL Input Section -->
            <div class="parse-section card">
                <h3>Parse Funding URL</h3>
                <div class="url-input-container">
                    <input type="text" id="funding-url" placeholder="Paste funding opportunity URL here..." class="url-input">
                    <button type="button" id="parse-btn" class="btn" onclick="parseURL()">
                        <span id="parse-btn-text">üîç Parse</span>
                        <span id="parse-loading" class="hidden">‚è≥ Parsing...</span>
                    </button>
                </div>
            </div>

            <!-- URL Already Exists Warning (hidden initially) -->
            <div id="url-exists-warning" class="card warning-card hidden">
                <h3>‚ö†Ô∏è URL Already Exists</h3>
                <div id="existing-info" class="existing-info">
                    <p><strong>This funding opportunity already exists in the system.</strong></p>
                    <div class="existing-details">
                        <p><strong>Title:</strong> <span id="existing-title"></span></p>
                        <p><strong>Donor:</strong> <span id="existing-donor"></span></p>
                        <p><strong>Added:</strong> <span id="existing-date"></span></p>
                        <p><strong>Status:</strong> <span id="existing-status"></span></p>
                    </div>
                </div>
                <div class="reparse-actions">
                    <button type="button" id="reparse-btn" class="btn btn-secondary" onclick="reparseURL()">
                        <span id="reparse-btn-text">üîÑ Re-Parse Anyway</span>
                        <span id="reparse-loading" class="hidden">‚è≥ Re-parsing...</span>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showExistingRecord()">üìã Use Existing Record</button>
                </div>
            </div>

            <!-- Side-by-Side Comparison (hidden initially) -->
            <div id="comparison-section" class="card hidden">
                <h3>üìä Data Comparison: Existing vs New</h3>
                <p class="comparison-help">Review the changes and choose which version to keep:</p>
                
                <div class="comparison-grid">
                    <div class="comparison-column">
                        <h4>üóÇÔ∏è Existing Data</h4>
                        <div id="existing-data-preview" class="data-preview">
                            <!-- Existing data will be populated here -->
                        </div>
                    </div>
                    <div class="comparison-column">
                        <h4>üÜï Newly Parsed Data</h4>
                        <div id="new-data-preview" class="data-preview">
                            <!-- New data will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="comparison-actions">
                    <button type="button" class="btn btn-primary" onclick="useNewData()">‚úÖ Overwrite with New Data</button>
                    <button type="button" class="btn btn-secondary" onclick="keepExistingData()">üîô Keep Existing Data</button>
                    <button type="button" class="btn btn-danger" onclick="discardComparison()">‚ùå Cancel</button>
                </div>
            </div>

            <!-- Parsed Data Form (hidden initially) -->
            <div id="parsed-data-section" class="card hidden">
                <h3>Edit Parsed Data</h3>
                <div id="parse-message" class="message hidden"></div>
                
                <form id="qa-edit-form">
                    <input type="hidden" id="record-id" value="">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="title">Title *</label>
                            <input type="text" id="title" name="title" required class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="donor">Donor *</label>
                            <input type="text" id="donor" name="donor" required class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="deadline">Deadline *</label>
                            <input type="text" id="deadline" name="deadline" required class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="amount">Amount</label>
                            <input type="text" id="amount" name="amount" class="form-control">
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="countries">Countries (multi-select)</label>
                            <select id="countries" name="countries" multiple class="form-control multi-select">
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="England">England</option>
                                <option value="Scotland">Scotland</option>
                                <option value="Wales">Wales</option>
                                <option value="Northern Ireland">Northern Ireland</option>
                                <option value="United States">United States</option>
                                <option value="India">India</option>
                                <option value="International">International</option>
                                <option value="Europe">Europe</option>
                                <option value="Global">Global</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="themes">Themes (multi-select)</label>
                            <select id="themes" name="themes" multiple class="form-control multi-select">
                                <option value="Education">Education</option>
                                <option value="Health">Health</option>
                                <option value="Environment">Environment</option>
                                <option value="Technology">Technology</option>
                                <option value="Community">Community</option>
                                <option value="Arts">Arts</option>
                                <option value="Social Justice">Social Justice</option>
                                <option value="Youth">Youth</option>
                                <option value="Elderly">Elderly</option>
                                <option value="Digital Inclusion">Digital Inclusion</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="description">Description *</label>
                            <textarea id="description" name="description" required class="form-control" rows="4"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="opportunity_url">Opportunity URL *</label>
                            <input type="url" id="opportunity_url" name="opportunity_url" required class="form-control" readonly>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="qa-notes">QA Notes (optional)</label>
                            <textarea id="qa-notes" name="qa_notes" class="form-control" rows="3" placeholder="Add any QA review notes or comments..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="save-record-btn" class="btn btn-success" onclick="saveFinalRecord()">
                            <span id="save-btn-text">üíæ Save Final Record</span>
                            <span id="save-loading" class="hidden">‚è≥ Saving...</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Clear Form</button>
                    </div>
                </form>
                
                <div id="save-success" class="success-message hidden">
                    <h4>‚úÖ Record Approved Successfully!</h4>
                    <p>The funding opportunity has been approved and is ready for Step 2.</p>
                    <button type="button" class="btn" onclick="moveToStep2()">‚û°Ô∏è Next: Generate Blog Post</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Generate and Edit Blog Post (hidden initially) -->
        <div id="step2-section" class="workflow-section hidden">
            <div class="workflow-header">
                <h2>ü§ñ Step 2: Generate & Edit Blog Post</h2>
                <p>Generate AI-powered blog content, edit as needed, and publish to WordPress.</p>
            </div>

            <!-- Blog Generation Section -->
            <div class="card">
                <h3>Generate Blog Post</h3>
                <div id="blog-generation-controls" class="generation-controls">
                    <div class="control-row">
                        <div class="control-group">
                            <label for="seo-keywords">SEO Keywords (optional)</label>
                            <input type="text" id="seo-keywords" placeholder="funding, grants, nonprofits..." class="form-control">
                        </div>
                        <div class="control-group">
                            <label for="tone-select">Tone</label>
                            <select id="tone-select" class="form-control">
                                <option value="professional">Professional</option>
                                <option value="persuasive">Persuasive</option>
                                <option value="informal">Informal</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="length-select">Length</label>
                            <select id="length-select" class="form-control">
                                <option value="short">Short (800-1200 words)</option>
                                <option value="medium" selected>Medium (1200-1800 words)</option>
                                <option value="long">Long (1800-2500 words)</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group full-width">
                            <label for="extra-instructions">Extra Instructions (optional)</label>
                            <textarea id="extra-instructions" placeholder="Focus on small nonprofits, emphasize urgency, etc..." class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="control-actions">
                        <button type="button" id="generate-blog-btn" class="btn" onclick="generateBlogPost()">
                            <span id="generate-blog-text">ü§ñ Generate Blog Post</span>
                            <span id="generate-blog-loading" class="hidden">‚è≥ Generating...</span>
                        </button>
                        <button type="button" id="regenerate-blog-btn" class="btn btn-secondary hidden" onclick="regenerateBlogPost()">
                            <span id="regenerate-blog-text">üîÑ Regenerate Blog Post</span>
                            <span id="regenerate-blog-loading" class="hidden">‚è≥ Regenerating...</span>
                        </button>
                    </div>
                    <div id="existing-blog-notice" class="hidden" style="margin-top: 10px; padding: 10px; background: #e8f4f8; border-left: 4px solid #2196F3; border-radius: 4px;">
                        <p><strong>üìù Existing Blog Post Found</strong></p>
                        <p>A saved blog post already exists for this funding opportunity. Click "Generate Blog Post" to load it, or "Regenerate Blog Post" to create a new version.</p>
                    </div>
                </div>
            </div>

            <!-- Blog Edit Section (hidden initially) -->
            <div id="blog-edit-section" class="card hidden">
                <h3>Edit Generated Blog Post</h3>
                <div id="blog-message" class="message hidden"></div>
                
                <form id="blog-edit-form">
                    <div class="blog-form-grid">
                        <div class="form-group">
                            <label for="blog-title">Post Title *</label>
                            <input type="text" id="blog-title" name="blog_title" required class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="meta-title">Meta Title *</label>
                            <input type="text" id="meta-title" name="meta_title" required class="form-control" maxlength="60">
                            <small class="char-count">0/60 characters</small>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="meta-description">Meta Description *</label>
                            <textarea id="meta-description" name="meta_description" required class="form-control" rows="3" maxlength="160"></textarea>
                            <small class="char-count">0/160 characters</small>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="blog-content">Post Body *</label>
                            <textarea id="blog-content" name="blog_content" required class="form-control blog-textarea" rows="20"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="blog-tags">Tags</label>
                            <input type="text" id="blog-tags" name="blog_tags" class="form-control" placeholder="funding, grants, nonprofits">
                            <small>Comma-separated</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="blog-categories">Categories</label>
                            <input type="text" id="blog-categories" name="blog_categories" class="form-control" placeholder="Funding Opportunities">
                            <small>Comma-separated</small>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="publish-wp-btn" class="btn btn-success" onclick="publishToWordPress()">
                            <span id="publish-wp-text">üìù Publish to WordPress</span>
                            <span id="publish-wp-loading" class="hidden">‚è≥ Publishing...</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearBlogForm()">üóëÔ∏è Clear Form</button>
                    </div>
                </form>
                
                <div id="publish-success" class="success-message hidden">
                    <h4>‚úÖ Published to WordPress Successfully!</h4>
                    <p>Your blog post has been created as a draft in WordPress.</p>
                    <div class="success-actions">
                        <button type="button" class="btn" onclick="moveToStep3()">‚û°Ô∏è Next: Generate Proposal Template</button>
                        <a id="wp-post-link" href="#" target="_blank" class="btn btn-secondary">üëÅÔ∏è View in WordPress</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Generate and Edit Proposal Template (hidden initially) -->
        <div id="step3-section" class="workflow-section hidden">
            <div class="workflow-header">
                <h2>üìÑ Step 3: Generate & Edit Proposal Template</h2>
                <p>Create a customized proposal template skeleton, edit the sections, and download as .docx.</p>
            </div>

            <!-- Template Generation Section -->
            <div class="card">
                <h3>Generate Proposal Template</h3>
                <div id="template-generation-controls" class="generation-controls">
                    <div class="control-row">
                        <div class="control-group">
                            <label for="template-funder-notes">Funder Requirements & Notes (Optional)</label>
                            <textarea id="template-funder-notes" rows="3" class="form-control" 
                                      placeholder="e.g., Maximum 2 pages, use specific Excel budget template, include letters of support..."></textarea>
                        </div>
                    </div>
                    
                    <div class="control-actions">
                        <button type="button" id="generate-template-btn" class="btn btn-primary" onclick="generateProposalTemplate()">
                            <span id="generate-template-text">üìÑ Generate Proposal Template</span>
                            <span id="generate-template-loading" class="hidden">‚è≥ Generating...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Template Edit Section (hidden initially) -->
            <div id="template-edit-section" class="card hidden">
                <h3>Edit Template Sections</h3>
                <div id="template-sections-container">
                    <!-- Dynamic sections will be added here -->
                </div>
                
                <div class="template-actions">
                    <button type="button" class="btn btn-success" onclick="addTemplateSection()">‚ûï Add New Section</button>
                    <button type="button" id="finalize-template-btn" class="btn btn-primary" onclick="finalizeTemplate()">
                        <span id="finalize-template-text">üéØ Finalize & Generate .docx</span>
                        <span id="finalize-template-loading" class="hidden">‚è≥ Generating .docx...</span>
                    </button>
                </div>
            </div>

            <!-- Template Download Section (hidden initially) -->
            <div id="template-download-section" class="card hidden">
                <h3>‚úÖ Template Ready for Download</h3>
                <div class="download-info">
                    <div class="download-details">
                        <p><strong>Template:</strong> <span id="template-filename"></span></p>
                        <p><strong>Generated:</strong> <span id="template-timestamp"></span></p>
                        <p><strong>Sections:</strong> <span id="template-sections-count"></span></p>
                    </div>
                    <div class="download-actions">
                        <a id="download-template-link" href="#" class="btn btn-success" download>
                            üì• Download .docx Template
                        </a>
                        <button type="button" class="btn btn-secondary" onclick="resetTemplateGeneration()">üîÑ Generate New Template</button>
                    </div>
                </div>
                
                <div class="workflow-completion">
                    <h4>üéâ QA Workflow Complete!</h4>
                    <p>You have successfully:</p>
                    <ul class="completion-checklist">
                        <li>‚úÖ Parsed and curated the funding opportunity</li>
                        <li>‚úÖ Generated and published the blog post</li>
                        <li>‚úÖ Created and downloaded the proposal template</li>
                    </ul>
                    <div class="completion-actions">
                        <button type="button" class="btn btn-primary" onclick="startNewWorkflow()">üÜï Start New Workflow</button>
                        <a href="/admin/qa-review" class="btn btn-secondary">üìã Back to QA Review</a>
                    </div>
                </div>
            </div>

            <!-- Template Generation Messages -->
            <div id="template-error" class="error-message hidden">
                <h4>‚ùå Template Generation Failed</h4>
                <p id="template-error-text"></p>
                <button type="button" class="btn btn-secondary" onclick="retryTemplateGeneration()">üîÑ Try Again</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_opportunities }}</div>
                <div class="stat-label">Total Opportunities</div>
            </div>
            <div class="stat-card raw">
                <div class="stat-number">{{ stats.raw_opportunities }}</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card reviewed">
                <div class="stat-number">{{ stats.reviewed_opportunities }}</div>
                <div class="stat-label">Reviewed</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-number">{{ stats.approved_opportunities }}</div>
                <div class="stat-label">Approved</div>
            </div>
        </div>

        <!-- TODO Section -->
        <div class="todo-section">
            <h2>üöß Implementation Status</h2>
            <ul class="todo-list">
                <li><strong>‚úÖ Step 1 - Parse & Curate:</strong> Complete URL parsing, editing, and QA approval workflow</li>
                <li><strong>‚úÖ Step 2 - Generate & Edit Blog Post:</strong> AI generation, editing, database persistence, and WordPress publishing</li>
                <li><strong>‚úÖ Step 3 - Proposal Templates:</strong> Complete template generation, editing, and .docx download</li>
                <li><strong>‚úÖ 3-Step QA Workflow:</strong> Fully integrated end-to-end process with manual learning logs</li>
                <li><strong>‚úÖ QA Review Dashboard:</strong> Fully implemented with feedback capture</li>
                <li><strong>‚úÖ Proposal Template Generator:</strong> Fully implemented with .docx generation</li>
                <li><strong>‚ö†Ô∏è Advanced Analytics:</strong> Data collection ready, dashboard pending</li>
                <li><strong>‚ö†Ô∏è Settings Management:</strong> Configuration system pending</li>
            </ul>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Recent Opportunities -->
            <div class="card">
                <h2>üìã Recent Opportunities</h2>
                {% if recent_opportunities %}
                <ul class="recent-list">
                    {% for opp in recent_opportunities %}
                    <li class="recent-item">
                        <div>
                            <div class="recent-title">{{ opp.title }}</div>
                            <div class="recent-meta">{{ opp.donor }} ‚Ä¢ {{ opp.created_at }}</div>
                        </div>
                        <span class="status-badge status-{{ opp.status }}">{{ opp.status }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No opportunities found. Parse some funding opportunities to get started.</p>
                {% endif %}
            </div>

            <!-- Quick Stats -->
            <div class="card">
                <h2>üìä Feedback Summary</h2>
                <div style="margin-bottom: 1rem;">
                    <strong>Parsed Data Edits:</strong> {{ feedback_stats.parsed_data_feedback.total_edits }}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Blog Post Edits:</strong> {{ feedback_stats.post_edit_feedback.total_edits }}
                </div>
                {% if feedback_stats.parsed_data_feedback.most_edited_fields %}
                <div>
                    <strong>Most Edited Fields:</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 1rem;">
                        {% for field in feedback_stats.parsed_data_feedback.most_edited_fields[:3] %}
                        <li>{{ field.field }} ({{ field.edit_count }})</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Admin Functions -->
        <div class="admin-functions">
            <div class="function-card">
                <div class="function-icon">üìã</div>
                <h3>QA Review</h3>
                <p>Review and approve parsed funding opportunities. Edit data and provide feedback.</p>
                <a href="/admin/qa-review" class="btn">Review Opportunities</a>
            </div>

            <div class="function-card">
                <div class="function-icon">üìÑ</div>
                <h3>Proposal Templates</h3>
                <p>Generate customized proposal templates for approved funding opportunities.</p>
                <a href="/admin/proposal-template/start" class="btn">Create Template</a>
            </div>

            <div class="function-card">
                <div class="function-icon">ü§ñ</div>
                <h3>Blog Post Generator</h3>
                <p>Generate SEO-optimized blog posts from funding opportunities using AI.</p>
                <a href="/admin/dashboard" class="btn">Generate Posts</a>
            </div>

            <div class="function-card">
                <div class="function-icon">üìù</div>
                <h3>WordPress Publisher</h3>
                <p>Publish generated blog posts directly to WordPress as drafts.</p>
                <a href="/admin/dashboard" class="btn">Publish Posts</a>
            </div>

            <div class="function-card">
                <div class="function-icon">üìä</div>
                <h3>Analytics & Feedback</h3>
                <p>Analyze QA feedback patterns and system performance metrics.</p>
                <a href="/admin/feedback/stats" class="btn">View Analytics</a>
            </div>

            <div class="function-card">
                <div class="function-icon">‚öôÔ∏è</div>
                <h3>Settings</h3>
                <p>Configure system settings, user management, and integrations.</p>
                <button type="button" class="btn btn-disabled" onclick="showSettingsPlaceholder()">‚ö†Ô∏è Coming Soon</button>
                <div class="placeholder-note">
                    <small class="text-muted">Settings management system is planned for future release</small>
                </div>
            </div>
        </div>

        <!-- Hidden CSRF Token -->
        <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
    </div>

    <script>
        // Add any dashboard-specific JavaScript here
        console.log('ReqAgent Admin Dashboard loaded');
        
        // Global variables for Step 1 workflow
        let originalParsedData = {};
        let currentRecordId = null;
        
        // Example function to handle CSRF token
        function getCSRFToken() {
            return document.getElementById('csrf-token').value;
        }
        
        // Example AJAX helper with CSRF protection
        function secureAjax(url, data, method = 'POST') {
            return fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCSRFToken()
                },
                body: JSON.stringify(data)
            });
        }
        
        // Global variables for comparison functionality
        let existingRecordData = null;
        let newRecordData = null;
        let isReparsing = false;

        // Step 1: Parse URL functionality with duplicate handling
        async function parseURL(forceReparse = false) {
            const urlInput = document.getElementById('funding-url');
            const parseBtn = document.getElementById('parse-btn');
            const parseBtnText = document.getElementById('parse-btn-text');
            const parseLoading = document.getElementById('parse-loading');
            const parsedSection = document.getElementById('parsed-data-section');
            const urlExistsWarning = document.getElementById('url-exists-warning');
            const comparisonSection = document.getElementById('comparison-section');
            
            const url = urlInput.value.trim();
            
            if (!url) {
                showMessage('Please enter a valid URL', 'error');
                return;
            }
            
            // Show loading state
            parseBtn.disabled = true;
            parseBtnText.classList.add('hidden');
            parseLoading.classList.remove('hidden');
            
            // Hide existing sections
            urlExistsWarning.classList.add('hidden');
            comparisonSection.classList.add('hidden');
            parsedSection.classList.add('hidden');
            
            try {
                // Build URL with force parameter if needed
                const apiUrl = forceReparse ? `/api/requirement/parse?force_refresh=true` : '/api/requirement/parse';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.already_exists && !forceReparse) {
                        // URL already exists - show warning
                        showURLExistsWarning(result);
                    } else if (result.existing_entry && result.new_entry && forceReparse) {
                        // Force re-parse completed - show comparison
                        showComparison(result);
                    } else {
                        // New URL - proceed normally
                        await handleNewURL(result);
                    }
                } else {
                    showMessage(`Failed to parse URL: ${result.detail || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Parse error:', error);
                showMessage(`Error parsing URL: ${error.message}`, 'error');
            } finally {
                // Reset button state
                parseBtn.disabled = false;
                parseBtnText.classList.remove('hidden');
                parseLoading.classList.add('hidden');
            }
        }
        
        // Show URL already exists warning
        function showURLExistsWarning(result) {
            const urlExistsWarning = document.getElementById('url-exists-warning');
            const existingData = result.existing_entry.json_data || {};
            
            document.getElementById('existing-title').textContent = existingData.title || 'Unknown';
            document.getElementById('existing-donor').textContent = existingData.donor || 'Unknown';
            document.getElementById('existing-date').textContent = new Date(result.existing_entry.created_at).toLocaleDateString();
            document.getElementById('existing-status').textContent = result.existing_entry.status || 'Unknown';
            
            urlExistsWarning.classList.remove('hidden');
            urlExistsWarning.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Store existing data for potential use
            existingRecordData = result;
        }
        
        // Handle new URL parsing
        async function handleNewURL(result) {
            // Store original data for feedback comparison
            originalParsedData = result.data.json_data || {};
            currentRecordId = result.data.id;
            
            // Check for existing blog post
            await checkExistingBlogPost(currentRecordId);
            
            // Populate form with parsed data
            populateForm(originalParsedData, document.getElementById('funding-url').value);
            
            // Show success message
            showMessage(result.message, 'success');
            
            // Show the form section
            const parsedSection = document.getElementById('parsed-data-section');
            parsedSection.classList.remove('hidden');
            parsedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Re-parse URL with force flag
        async function reparseURL() {
            const reparseBtn = document.getElementById('reparse-btn');
            const reparseBtnText = document.getElementById('reparse-btn-text');
            const reparseLoading = document.getElementById('reparse-loading');
            
            // Show loading state
            reparseBtn.disabled = true;
            reparseBtnText.classList.add('hidden');
            reparseLoading.classList.remove('hidden');
            
            try {
                await parseURL(true); // Force re-parse
            } finally {
                // Reset button state
                reparseBtn.disabled = false;
                reparseBtnText.classList.remove('hidden');
                reparseLoading.classList.add('hidden');
            }
        }
        
        // Show existing record (skip re-parsing)
        async function showExistingRecord() {
            if (existingRecordData) {
                await handleNewURL(existingRecordData);
            }
        }
        
        // Show side-by-side comparison
        function showComparison(result) {
            const comparisonSection = document.getElementById('comparison-section');
            const existingPreview = document.getElementById('existing-data-preview');
            const newPreview = document.getElementById('new-data-preview');
            
            // Store data for later use
            existingRecordData = result;
            newRecordData = result;
            
            // Populate existing data preview
            const existingData = result.existing_extracted_data || {};
            existingPreview.innerHTML = createDataPreview(existingData, 'existing');
            
            // Populate new data preview
            const newData = result.new_extracted_data || {};
            newPreview.innerHTML = createDataPreview(newData, 'new', existingData);
            
            // Show comparison section
            comparisonSection.classList.remove('hidden');
            comparisonSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Create data preview HTML
        function createDataPreview(data, type, comparisonData = null) {
            const fields = [
                { key: 'title', label: 'Title' },
                { key: 'donor', label: 'Donor' },
                { key: 'amount', label: 'Amount' },
                { key: 'deadline', label: 'Deadline' },
                { key: 'description', label: 'Description' },
                { key: 'eligibility', label: 'Eligibility' },
                { key: 'themes', label: 'Themes' },
                { key: 'location', label: 'Location' }
            ];
            
            let html = '';
            
            fields.forEach(field => {
                const value = data[field.key] || 'Not specified';
                const isChanged = comparisonData && comparisonData[field.key] !== data[field.key];
                const fieldClass = isChanged ? 'field-changed' : '';
                
                html += `
                    <div class="field-item ${fieldClass}">
                        <div class="field-label">${field.label}</div>
                        <div class="field-value">${value}</div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // Use new data (overwrite existing)
        async function useNewData() {
            if (newRecordData && newRecordData.new_entry) {
                try {
                    // Update the database with new data
                    const response = await fetch(`/api/requirement/opportunities/${newRecordData.new_entry.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            json_data: newRecordData.new_entry.json_data,
                            status: 'approved'  // Set to approved for workflow
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('‚úÖ Successfully updated with new data', 'success');
                        
                        // Proceed with the new data in the workflow
                        originalParsedData = newRecordData.new_entry.json_data || {};
                        currentRecordId = newRecordData.new_entry.id;
                        
                        // Check for existing blog post
                        await checkExistingBlogPost(currentRecordId);
                        
                        // Populate form and show parsed section
                        populateForm(originalParsedData, document.getElementById('funding-url').value);
                        
                        // Hide comparison, show parsed data section
                        document.getElementById('comparison-section').classList.add('hidden');
                        const parsedSection = document.getElementById('parsed-data-section');
                        parsedSection.classList.remove('hidden');
                        parsedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        
                    } else {
                        showMessage('‚ùå Failed to update record', 'error');
                    }
                } catch (error) {
                    console.error('Update error:', error);
                    showMessage('‚ùå Error updating record: ' + error.message, 'error');
                }
            }
        }
        
        // Keep existing data (discard new)
        async function keepExistingData() {
            if (existingRecordData && existingRecordData.existing_entry) {
                showMessage('üìã Keeping existing data', 'success');
                
                // Use existing data in workflow
                originalParsedData = existingRecordData.existing_entry.json_data || {};
                currentRecordId = existingRecordData.existing_entry.id;
                
                // Check for existing blog post
                await checkExistingBlogPost(currentRecordId);
                
                // Populate form and show parsed section
                populateForm(originalParsedData, document.getElementById('funding-url').value);
                
                // Hide comparison, show parsed data section
                document.getElementById('comparison-section').classList.add('hidden');
                const parsedSection = document.getElementById('parsed-data-section');
                parsedSection.classList.remove('hidden');
                parsedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Discard comparison and start over
        function discardComparison() {
            // Hide all sections
            document.getElementById('comparison-section').classList.add('hidden');
            document.getElementById('url-exists-warning').classList.add('hidden');
            document.getElementById('parsed-data-section').classList.add('hidden');
            
            // Clear URL input
            document.getElementById('funding-url').value = '';
            
            // Reset global variables
            existingRecordData = null;
            newRecordData = null;
            originalParsedData = {};
            currentRecordId = null;
            
            showMessage('‚ùå Parsing cancelled', 'info');
        }
        
        // Populate form with parsed data
        function populateForm(data, url) {
            // Basic fields
            document.getElementById('title').value = data.title || '';
            document.getElementById('donor').value = data.donor || '';
            document.getElementById('deadline').value = data.deadline || '';
            document.getElementById('amount').value = data.amount || '';
            document.getElementById('description').value = data.summary || data.description || '';
            document.getElementById('opportunity_url').value = data.opportunity_url || url;
            document.getElementById('record-id').value = currentRecordId || '';
            
            // Multi-select fields
            populateMultiSelect('countries', data.location || data.countries || []);
            populateMultiSelect('themes', data.themes || []);
        }
        
        // Helper function to populate multi-select fields
        function populateMultiSelect(fieldId, values) {
            const select = document.getElementById(fieldId);
            const options = select.querySelectorAll('option');
            
            // Clear current selections
            options.forEach(option => option.selected = false);
            
            // Handle both array and string values
            const valueArray = Array.isArray(values) ? values : [values];
            
            valueArray.forEach(value => {
                if (value) {
                    const option = Array.from(options).find(opt => 
                        opt.value.toLowerCase().includes(value.toLowerCase()) ||
                        value.toLowerCase().includes(opt.value.toLowerCase())
                    );
                    if (option) {
                        option.selected = true;
                    }
                }
            });
        }
        
        // Save final record functionality
        async function saveFinalRecord() {
            const saveBtn = document.getElementById('save-record-btn');
            const saveBtnText = document.getElementById('save-btn-text');
            const saveLoading = document.getElementById('save-loading');
            const successMessage = document.getElementById('save-success');
            
            if (!currentRecordId) {
                showMessage('No record to save. Please parse a URL first.', 'error');
                return;
            }
            
            // Show loading state
            saveBtn.disabled = true;
            saveBtnText.classList.add('hidden');
            saveLoading.classList.remove('hidden');
            
            try {
                // Collect form data
                const formData = {
                    record_id: currentRecordId,
                    field_updates: {
                        title: document.getElementById('title').value,
                        donor: document.getElementById('donor').value,
                        deadline: document.getElementById('deadline').value,
                        amount: document.getElementById('amount').value,
                        summary: document.getElementById('description').value,
                        opportunity_url: document.getElementById('opportunity_url').value,
                        location: Array.from(document.getElementById('countries').selectedOptions).map(opt => opt.value),
                        themes: Array.from(document.getElementById('themes').selectedOptions).map(opt => opt.value)
                    },
                    editable_text: document.getElementById('qa-notes').value,
                    status: 'approved',
                    prompt_version: 'v2.0'
                };
                
                // Submit to QA endpoint
                const response = await fetch('/admin/qa-review/update-with-feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Log QA action for manual learning
                    await logQAAction(originalParsedData, formData.field_updates);
                    
                    // Show success message
                    successMessage.classList.remove('hidden');
                    document.getElementById('qa-edit-form').style.display = 'none';
                    
                    showMessage(`Record saved successfully! ${result.feedback_count} feedback entries captured.`, 'success');
                    
                } else {
                    showMessage(`Failed to save record: ${result.detail || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                showMessage(`Error saving record: ${error.message}`, 'error');
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                saveBtnText.classList.remove('hidden');
                saveLoading.classList.add('hidden');
            }
        }
        
        // Log QA action for manual learning
        async function logQAAction(originalData, editedData) {
            try {
                const logData = {
                    action: 'qa_field_edit',
                    record_id: currentRecordId,
                    original_data: originalData,
                    edited_data: editedData,
                    timestamp: new Date().toISOString(),
                    user: '{{ current_user }}'
                };
                
                // This logs the action for manual learning analysis
                console.log('QA Action Logged:', logData);
                
                // TODO: Add dedicated logging endpoint if needed
                // await fetch('/api/log-qa-action', { ... });
                
            } catch (error) {
                console.error('Logging error:', error);
                // Don't fail the main process if logging fails
            }
        }
        
        // Utility functions
        function showMessage(text, type) {
            const messageDiv = document.getElementById('parse-message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.classList.remove('hidden');
        }
        
        function clearForm() {
            document.getElementById('qa-edit-form').reset();
            document.getElementById('parsed-data-section').classList.add('hidden');
            document.getElementById('save-success').classList.add('hidden');
            document.getElementById('qa-edit-form').style.display = 'block';
            document.getElementById('funding-url').value = '';
            currentRecordId = null;
            originalParsedData = {};
        }
        
        function moveToStep2() {
            // Show Step 2 section
            const step2Section = document.getElementById('step2-section');
            step2Section.classList.remove('hidden');
            
            // Scroll to Step 2
            step2Section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Focus on first input
            document.getElementById('seo-keywords').focus();
        }
        
        // Step 3: Proposal Template Generation functionality
        let templateSectionCounter = 0;
        let originalTemplateData = {};
        
        function initializeDefaultTemplateSections() {
            const container = document.getElementById('template-sections-container');
            container.innerHTML = ''; // Clear existing sections
            templateSectionCounter = 0;
            
            // Add default sections
            addTemplateSection('Project Goals & Objectives', 'Describe what your project aims to achieve in 2-3 sentences. Include specific, measurable outcomes.');
            addTemplateSection('Project Description', 'Provide a detailed description of your project activities, methodology, and timeline.');
            addTemplateSection('Budget & Financial Plan', 'Use the donor\'s provided format if available. Include high-level breakdown and justification.');
            addTemplateSection('Impact & Expected Outcomes', 'Describe the anticipated impact of your project and how you will measure success.');
        }
        
        function addTemplateSection(heading = '', instruction = '') {
            templateSectionCounter++;
            const container = document.getElementById('template-sections-container');
            
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'template-section-item';
            sectionDiv.innerHTML = `
                <div class="template-section-header">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <div class="template-section-number">${templateSectionCounter}</div>
                        <input type="text" placeholder="Section Heading" value="${heading}" 
                               class="template-section-heading" onchange="updateTemplateSectionNumbers()">
                    </div>
                    <div class="template-section-controls">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="moveTemplateSection(this, 'up')">‚Üë</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="moveTemplateSection(this, 'down')">‚Üì</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeTemplateSection(this)">‚úï</button>
                    </div>
                </div>
                <textarea class="template-section-instruction" rows="3" 
                          placeholder="Instructions for this section (what should be included, word limits, specific requirements...)">${instruction}</textarea>
            `;
            
            container.appendChild(sectionDiv);
        }
        
        function removeTemplateSection(button) {
            button.closest('.template-section-item').remove();
            updateTemplateSectionNumbers();
        }
        
        function moveTemplateSection(button, direction) {
            const section = button.closest('.template-section-item');
            const container = section.parentNode;
            
            if (direction === 'up' && section.previousElementSibling) {
                container.insertBefore(section, section.previousElementSibling);
            } else if (direction === 'down' && section.nextElementSibling) {
                container.insertBefore(section.nextElementSibling, section);
            }
            
            updateTemplateSectionNumbers();
        }
        
        function updateTemplateSectionNumbers() {
            const sections = document.querySelectorAll('.template-section-item');
            sections.forEach((section, index) => {
                const numberDiv = section.querySelector('.template-section-number');
                numberDiv.textContent = index + 1;
            });
        }
        
        async function generateProposalTemplate() {
            const generateBtn = document.getElementById('generate-template-btn');
            const generateText = document.getElementById('generate-template-text');
            const generateLoading = document.getElementById('generate-template-loading');
            const editSection = document.getElementById('template-edit-section');
            const errorSection = document.getElementById('template-error');
            
            if (!currentRecordId) {
                showTemplateError('No record ID available. Please complete Step 1 first.');
                return;
            }
            
            // Show loading state
            generateBtn.disabled = true;
            generateText.classList.add('hidden');
            generateLoading.classList.remove('hidden');
            errorSection.classList.add('hidden');
            
            try {
                // Simply show the edit section with default template sections
                // Store original template data
                originalTemplateData = {
                    funder_notes: document.getElementById('template-funder-notes').value,
                    sections: getTemplateSections(),
                    timestamp: new Date().toISOString()
                };
                
                // Show edit section
                editSection.classList.remove('hidden');
                
                // Scroll to edit section
                editSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Log QA action for template generation start
                await logQAAction('template_generation_started', {
                    record_id: currentRecordId,
                    funder_notes: originalTemplateData.funder_notes,
                    sections_count: originalTemplateData.sections.length,
                    original_sections: originalTemplateData.sections
                });
                
            } catch (error) {
                console.error('Template generation error:', error);
                showTemplateError('Failed to initialize template generation: ' + error.message);
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                generateText.classList.remove('hidden');
                generateLoading.classList.add('hidden');
            }
        }
        
        function getTemplateSections() {
            const sections = [];
            const sectionItems = document.querySelectorAll('.template-section-item');
            
            sectionItems.forEach(item => {
                const heading = item.querySelector('.template-section-heading').value.trim();
                const instruction = item.querySelector('.template-section-instruction').value.trim();
                
                if (heading && instruction) {
                    sections.push({ heading, instruction });
                }
            });
            
            return sections;
        }
        
        async function finalizeTemplate() {
            const finalizeBtn = document.getElementById('finalize-template-btn');
            const finalizeText = document.getElementById('finalize-template-text');
            const finalizeLoading = document.getElementById('finalize-template-loading');
            const downloadSection = document.getElementById('template-download-section');
            const errorSection = document.getElementById('template-error');
            
            if (!currentRecordId) {
                showTemplateError('No record ID available. Please complete Step 1 first.');
                return;
            }
            
            const sections = getTemplateSections();
            if (sections.length === 0) {
                showTemplateError('Please add at least one section with both heading and instruction.');
                return;
            }
            
            // Show loading state
            finalizeBtn.disabled = true;
            finalizeText.classList.add('hidden');
            finalizeLoading.classList.remove('hidden');
            errorSection.classList.add('hidden');
            
            try {
                const funderNotes = document.getElementById('template-funder-notes').value.trim();
                
                // Call the API to generate .docx
                const response = await fetch('/admin/proposal-template/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        record_id: currentRecordId,
                        sections: sections,
                        funder_notes: funderNotes || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show download section
                    document.getElementById('template-filename').textContent = result.filename;
                    document.getElementById('template-timestamp').textContent = new Date(result.timestamp).toLocaleString();
                    document.getElementById('template-sections-count').textContent = sections.length + ' sections';
                    
                    const downloadLink = document.getElementById('download-template-link');
                    downloadLink.href = result.download_url;
                    downloadLink.download = result.filename;
                    
                    downloadSection.classList.remove('hidden');
                    downloadSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Log QA action for template completion
                    await logQAAction('template_generation_completed', {
                        record_id: currentRecordId,
                        original_sections: originalTemplateData.sections,
                        final_sections: sections,
                        original_funder_notes: originalTemplateData.funder_notes,
                        final_funder_notes: funderNotes,
                        filename: result.filename,
                        edits_made: compareTemplateSections(originalTemplateData.sections, sections)
                    });
                    
                } else {
                    showTemplateError(result.message || 'Failed to generate template');
                }
                
            } catch (error) {
                console.error('Template finalization error:', error);
                showTemplateError('Network error: ' + error.message);
            } finally {
                // Reset button state
                finalizeBtn.disabled = false;
                finalizeText.classList.remove('hidden');
                finalizeLoading.classList.add('hidden');
            }
        }
        
        function compareTemplateSections(original, final) {
            const edits = [];
            
            // Compare section count
            if (original.length !== final.length) {
                edits.push(`Section count changed from ${original.length} to ${final.length}`);
            }
            
            // Compare individual sections
            const maxLength = Math.max(original.length, final.length);
            for (let i = 0; i < maxLength; i++) {
                const orig = original[i] || {};
                const fin = final[i] || {};
                
                if (orig.heading !== fin.heading) {
                    edits.push(`Section ${i+1} heading: "${orig.heading}" ‚Üí "${fin.heading}"`);
                }
                if (orig.instruction !== fin.instruction) {
                    edits.push(`Section ${i+1} instruction modified`);
                }
            }
            
            return edits;
        }
        
        function showTemplateError(message) {
            const errorSection = document.getElementById('template-error');
            const errorText = document.getElementById('template-error-text');
            
            errorText.textContent = message;
            errorSection.classList.remove('hidden');
            errorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function retryTemplateGeneration() {
            const errorSection = document.getElementById('template-error');
            errorSection.classList.add('hidden');
            generateProposalTemplate();
        }
        
        function resetTemplateGeneration() {
            const editSection = document.getElementById('template-edit-section');
            const downloadSection = document.getElementById('template-download-section');
            const errorSection = document.getElementById('template-error');
            
            editSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            
            // Reset form
            document.getElementById('template-funder-notes').value = '';
            initializeDefaultTemplateSections();
        }
        
        function startNewWorkflow() {
            // Reset all workflow sections
            const step1Section = document.querySelector('.workflow-section');
            const step2Section = document.getElementById('step2-section');
            const step3Section = document.getElementById('step3-section');
            
            // Hide Steps 2 & 3
            step2Section.classList.add('hidden');
            step3Section.classList.add('hidden');
            
            // Reset Step 1
            document.getElementById('funding-url').value = '';
            document.getElementById('parsed-data-section').classList.add('hidden');
            document.getElementById('save-success').classList.add('hidden');
            
            // Reset Step 2
            document.getElementById('blog-edit-section').classList.add('hidden');
            document.getElementById('publish-success').classList.add('hidden');
            
            // Reset Step 3
            resetTemplateGeneration();
            
            // Clear global state
            currentRecordId = null;
            originalBlogData = {};
            originalTemplateData = {};
            
            // Scroll to top
            step1Section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Focus on URL input
            document.getElementById('funding-url').focus();
        }
        
        // Step 2: Blog Post Generation functionality
        let originalBlogData = {};
        let existingBlogPost = null;
        
        // Check for existing blog post when record is loaded
        async function checkExistingBlogPost(recordId) {
            try {
                const response = await fetch(`/api/get-blog-post?record_id=${recordId}`);
                const result = await response.json();
                
                if (result.success && result.exists) {
                    existingBlogPost = result.blog_post;
                    showExistingBlogPostNotice(true);
                    updateBlogGenerationButtons(true);
                    return true;
                } else {
                    existingBlogPost = null;
                    showExistingBlogPostNotice(false);
                    updateBlogGenerationButtons(false);
                    return false;
                }
            } catch (error) {
                console.error('Error checking existing blog post:', error);
                existingBlogPost = null;
                showExistingBlogPostNotice(false);
                updateBlogGenerationButtons(false);
                return false;
            }
        }
        
        // Show/hide existing blog post notice
        function showExistingBlogPostNotice(show) {
            const notice = document.getElementById('existing-blog-notice');
            if (show) {
                notice.classList.remove('hidden');
            } else {
                notice.classList.add('hidden');
            }
        }
        
        // Update blog generation buttons based on existing post status
        function updateBlogGenerationButtons(hasExisting) {
            const generateBtn = document.getElementById('generate-blog-btn');
            const regenerateBtn = document.getElementById('regenerate-blog-btn');
            const generateText = document.getElementById('generate-blog-text');
            
            if (hasExisting) {
                generateText.textContent = 'üìù Load Existing Blog Post';
                regenerateBtn.classList.remove('hidden');
            } else {
                generateText.textContent = 'ü§ñ Generate Blog Post';
                regenerateBtn.classList.add('hidden');
            }
        }
        
        // Regenerate blog post (force new generation)
        async function regenerateBlogPost() {
            const regenerateBtn = document.getElementById('regenerate-blog-btn');
            const regenerateText = document.getElementById('regenerate-blog-text');
            const regenerateLoading = document.getElementById('regenerate-blog-loading');
            const blogEditSection = document.getElementById('blog-edit-section');
            const blogMessage = document.getElementById('blog-message');
            
            if (!currentRecordId) {
                showBlogMessage('No record available. Please complete Step 1 first.', 'error');
                return;
            }
            
            // Show loading state
            regenerateBtn.disabled = true;
            regenerateText.classList.add('hidden');
            regenerateLoading.classList.remove('hidden');
            
            try {
                // Collect generation parameters
                const requestData = {
                    record_id: currentRecordId,
                    seo_keywords: document.getElementById('seo-keywords').value.trim() || null,
                    tone: document.getElementById('tone-select').value,
                    length: document.getElementById('length-select').value,
                    extra_instructions: document.getElementById('extra-instructions').value.trim() || null,
                    force_regenerate: true
                };
                
                const response = await fetch('/api/regenerate-blog-post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store original data for feedback comparison
                    originalBlogData = {
                        post_title: result.post_title,
                        post_content: result.post_content,
                        meta_title: result.meta_title,
                        meta_description: result.meta_description,
                        tags: result.tags,
                        categories: result.categories
                    };
                    
                    // Populate blog edit form
                    populateBlogForm(result);
                    
                    // Show success message
                    showBlogMessage(result.message, 'success');
                    
                    // Show the edit section
                    blogEditSection.classList.remove('hidden');
                    
                    // Update existing post reference
                    existingBlogPost = result;
                    
                    // Scroll to edit form
                    blogEditSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                } else {
                    showBlogMessage(`Failed to regenerate blog post: ${result.detail || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Blog regeneration error:', error);
                showBlogMessage(`Error regenerating blog post: ${error.message}`, 'error');
            } finally {
                // Reset button state
                regenerateBtn.disabled = false;
                regenerateText.classList.remove('hidden');
                regenerateLoading.classList.add('hidden');
            }
        }
        
        async function generateBlogPost() {
            const generateBtn = document.getElementById('generate-blog-btn');
            const generateText = document.getElementById('generate-blog-text');
            const generateLoading = document.getElementById('generate-blog-loading');
            const blogEditSection = document.getElementById('blog-edit-section');
            const blogMessage = document.getElementById('blog-message');
            
            if (!currentRecordId) {
                showBlogMessage('No record available. Please complete Step 1 first.', 'error');
                return;
            }
            
            // Show loading state
            generateBtn.disabled = true;
            generateText.classList.add('hidden');
            generateLoading.classList.remove('hidden');
            
            try {
                // Collect generation parameters
                const requestData = {
                    record_id: currentRecordId,
                    seo_keywords: document.getElementById('seo-keywords').value.trim() || null,
                    tone: document.getElementById('tone-select').value,
                    length: document.getElementById('length-select').value,
                    extra_instructions: document.getElementById('extra-instructions').value.trim() || null
                };
                
                const response = await fetch('/api/generate-post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store original data for feedback comparison
                    originalBlogData = {
                        post_title: result.post_title,
                        post_content: result.post_content,
                        meta_title: result.meta_title,
                        meta_description: result.meta_description,
                        tags: result.tags,
                        categories: result.categories
                    };
                    
                    // Populate blog edit form
                    populateBlogForm(result);
                    
                    // Show success message with additional info
                    let message = result.message;
                    if (result.is_existing) {
                        message += ' | ‚ÑπÔ∏è This is a saved blog post from the database.';
                    } else {
                        message += ' | üíæ New blog post saved to database.';
                    }
                    showBlogMessage(message, 'success');
                    
                    // Show the edit section
                    blogEditSection.classList.remove('hidden');
                    
                    // Update existing post reference
                    if (result.blog_post_id) {
                        existingBlogPost = result;
                    }
                    
                    // Scroll to edit form
                    blogEditSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                } else {
                    showBlogMessage(`Failed to generate blog post: ${result.detail || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Blog generation error:', error);
                showBlogMessage(`Error generating blog post: ${error.message}`, 'error');
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                generateText.classList.remove('hidden');
                generateLoading.classList.add('hidden');
            }
        }
        
        // Populate blog edit form with generated data
        function populateBlogForm(data) {
            document.getElementById('blog-title').value = data.post_title || '';
            document.getElementById('meta-title').value = data.meta_title || '';
            document.getElementById('meta-description').value = data.meta_description || '';
            document.getElementById('blog-content').value = data.post_content || '';
            document.getElementById('blog-tags').value = Array.isArray(data.tags) ? data.tags.join(', ') : '';
            document.getElementById('blog-categories').value = Array.isArray(data.categories) ? data.categories.join(', ') : '';
            
            // Update character counts
            updateCharCount('meta-title', 60);
            updateCharCount('meta-description', 160);
        }
        
        // Publish to WordPress functionality
        async function publishToWordPress() {
            const publishBtn = document.getElementById('publish-wp-btn');
            const publishText = document.getElementById('publish-wp-text');
            const publishLoading = document.getElementById('publish-wp-loading');
            const publishSuccess = document.getElementById('publish-success');
            
            // Show loading state
            publishBtn.disabled = true;
            publishText.classList.add('hidden');
            publishLoading.classList.remove('hidden');
            
            try {
                // Collect edited blog data
                const editedBlogData = {
                    post_title: document.getElementById('blog-title').value,
                    post_content: document.getElementById('blog-content').value,
                    meta_title: document.getElementById('meta-title').value,
                    meta_description: document.getElementById('meta-description').value,
                    tags: document.getElementById('blog-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                    categories: document.getElementById('blog-categories').value.split(',').map(cat => cat.trim()).filter(cat => cat)
                };
                
                // Log edits for manual learning
                await logBlogEditAction(originalBlogData, editedBlogData);
                
                // Prepare WordPress publish data
                const publishData = {
                    title: editedBlogData.post_title,
                    content: editedBlogData.post_content,
                    meta_title: editedBlogData.meta_title,
                    meta_description: editedBlogData.meta_description,
                    tags: editedBlogData.tags,
                    categories: editedBlogData.categories,
                    opportunity_url: originalParsedData.opportunity_url || document.getElementById('opportunity_url').value
                };
                
                const response = await fetch('/api/wordpress/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(publishData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update WordPress link
                    const wpLink = document.getElementById('wp-post-link');
                    if (result.post_url) {
                        wpLink.href = result.post_url;
                        wpLink.style.display = 'inline-block';
                    }
                    
                    // Show success message
                    publishSuccess.classList.remove('hidden');
                    document.getElementById('blog-edit-form').style.display = 'none';
                    
                    showBlogMessage(result.message, 'success');
                    
                } else {
                    showBlogMessage(`Failed to publish to WordPress: ${result.detail || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('WordPress publish error:', error);
                showBlogMessage(`Error publishing to WordPress: ${error.message}`, 'error');
            } finally {
                // Reset button state
                publishBtn.disabled = false;
                publishText.classList.remove('hidden');
                publishLoading.classList.add('hidden');
            }
        }
        
        // Log blog edit action for manual learning
        async function logBlogEditAction(originalData, editedData) {
            try {
                const response = await fetch('/api/generate-post/feedback-with-original', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        record_id: currentRecordId,
                        original_post: originalData,
                        edited_post: editedData,
                        prompt_version: 'v1.2'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log(`Blog edit feedback captured: ${result.feedback_count} entries`);
                }
                
            } catch (error) {
                console.error('Blog edit logging error:', error);
                // Don't fail the main process if logging fails
            }
        }
        
        // Utility functions for Step 2
        function showBlogMessage(text, type) {
            const messageDiv = document.getElementById('blog-message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.classList.remove('hidden');
        }
        
        // Settings placeholder function
        function showSettingsPlaceholder() {
            const message = `‚öôÔ∏è Settings Management\n\nThe settings panel is planned for a future release and will include:\n\n‚Ä¢ User account management\n‚Ä¢ API configuration\n‚Ä¢ System preferences\n‚Ä¢ Integration settings\n‚Ä¢ Security options\n\nFor now, system configuration is handled via environment variables.`;
            alert(message);
        }
        
        function clearBlogForm() {
            document.getElementById('blog-edit-form').reset();
            document.getElementById('blog-edit-section').classList.add('hidden');
            document.getElementById('publish-success').classList.add('hidden');
            document.getElementById('blog-edit-form').style.display = 'block';
            originalBlogData = {};
        }
        
        function moveToStep3() {
            // Show Step 3 section
            const step3Section = document.getElementById('step3-section');
            step3Section.classList.remove('hidden');
            
            // Scroll to Step 3
            step3Section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Initialize default sections
            initializeDefaultTemplateSections();
            
            // Focus on first input
            document.getElementById('template-funder-notes').focus();
        }
        
        // Character count updates
        function updateCharCount(fieldId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = field.nextElementSibling;
            const currentLength = field.value.length;
            
            counter.textContent = `${currentLength}/${maxLength} characters`;
            
            if (currentLength > maxLength * 0.9) {
                counter.className = 'char-count warning';
            } else if (currentLength > maxLength) {
                counter.className = 'char-count error';
            } else {
                counter.className = 'char-count';
            }
        }
        
        // Allow Enter key to trigger parse
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('funding-url');
            if (urlInput) {
                urlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        parseURL();
                    }
                });
            }
            
            // Add character count listeners
            const metaTitle = document.getElementById('meta-title');
            const metaDescription = document.getElementById('meta-description');
            
            if (metaTitle) {
                metaTitle.addEventListener('input', () => updateCharCount('meta-title', 60));
            }
            if (metaDescription) {
                metaDescription.addEventListener('input', () => updateCharCount('meta-description', 160));
            }
        });
    </script>
</body>
</html> 